//@version=6
indicator("Crypto Box Re-entry: Alerts Only (R-based -1R / +3R)", overlay=true)

// inputs
upper = input.float(0.0, title="Upper \"Box\" Bound", step=0.01)
lower = input.float(0.0, title="Lower \"Box\" Bound", step=0.01)

spendUSD = input.float(100, title="Position Amount ($)", step=1, minval=1)
lossUSD  = input.float(50,  title="Risk per Trade (1R) ($)", step=1, minval=1)

cooldownBars  = input.int(0, title="Candles to wait before another alert", minval=0)


// visual
plot(upper, "Upper", linewidth=2)
plot(lower, "Lower", linewidth=2)

// constant for price adjusting with unit
pv = syminfo.pointvalue

// r-multiple for TP that can easily be adjusted (TP = +3R, SL = -1R)
rr = 3.0

f_qtyBySpend(entryPrice) =>
    notionalPerQty = entryPrice * pv
    notionalPerQty > 0 ? (spendUSD / notionalPerQty) : na

// convert your risk R into a price distance using qty and pointvalue
f_stopDist(entryPrice, qty) =>
    dollarsPerPriceMove = qty * pv
    dollarsPerPriceMove > 0 ? (lossUSD / dollarsPerPriceMove) : na

// pattern for when a close occurs outside of box, and then inside the box to follow the Darvas Strategy
brokeAboveClose = close > upper
brokeBelowClose = close < lower

backInsideFromAbove = close <= upper
backInsideFromBelow = close >= lower

var bool armedShort = false
var bool armedLong  = false
var float sweepHigh = na
var float sweepLow  = na

// cooldown handling
var int lastAlertBar = na
canAlertNow = cooldownBars == 0 ? true : (na(lastAlertBar) or bar_index - lastAlertBar > cooldownBars)

// arm and track sweep extremes while price is outside
if brokeAboveClose
    armedShort := true
    sweepHigh := na(sweepHigh) ? high : math.max(sweepHigh, high)

if brokeBelowClose
    armedLong := true
    sweepLow := na(sweepLow) ? low : math.min(sweepLow, low)

// signals: close back inside
shortSignal = armedShort and backInsideFromAbove
longSignal  = armedLong  and backInsideFromBelow

// construct alert message
f_fmt(x) => str.tostring(x, format.mintick)
f_qtyFmt(q) => str.tostring(q, "#.########")

if barstate.isconfirmed and canAlertNow and shortSignal and not na(sweepHigh)
    entry = close

    qty = f_qtyBySpend(entry)
    stopDist = not na(qty) ? f_stopDist(entry, qty) : na

    // only alert if sizing is valid
    if not na(qty) and qty > 0 and not na(stopDist) and stopDist > 0
        sl = entry + stopDist
        tp = entry - (rr * stopDist)

        msg =
          "BOX RE-ENTRY SIGNAL (SHORT)\n" +
          "1) Place a SHORT market/limit near entry\n" +
          "2) Set SL and TP as below\n\n" +
          "Symbol: " + syminfo.ticker + "\n" +
          "Entry (suggested): " + f_fmt(entry) + "\n" +
          "Stop Loss (-1R): " + f_fmt(sl) + "  (risk ≈ $" + str.tostring(lossUSD) + ")\n" +
          "Take Profit (+" + str.tostring(rr) + "R): " + f_fmt(tp) + "  (target ≈ $" + str.tostring(rr * lossUSD) + ")\n" +
          "Qty: " + f_qtyFmt(qty) + "\n\n" +
          "Inputs: Spend $" + str.tostring(spendUSD) + " | Risk (1R) $" + str.tostring(lossUSD) + "\n" +
          "Trigger: close back inside after close above upper."

        alert(msg, alert.freq_once_per_bar_close)
        lastAlertBar := bar_index

    // reset state to help prevent multiple signals from the same event
    armedShort := false
    sweepHigh := na
    armedLong := false
    sweepLow := na

if barstate.isconfirmed and canAlertNow and longSignal and not na(sweepLow)
    entry = close

    qty = f_qtyBySpend(entry)
    stopDist = not na(qty) ? f_stopDist(entry, qty) : na

    if not na(qty) and qty > 0 and not na(stopDist) and stopDist > 0
        sl = entry - stopDist
        tp = entry + (rr * stopDist)

        msg =
          "BOX RE-ENTRY SIGNAL (LONG)\n" +
          "1) Place a LONG market/limit near entry\n" +
          "2) Set SL and TP as below\n\n" +
          "Symbol: " + syminfo.ticker + "\n" +
          "Entry (suggested): " + f_fmt(entry) + "\n" +
          "Stop Loss (-1R): " + f_fmt(sl) + "  (risk ≈ $" + str.tostring(lossUSD) + ")\n" +
          "Take Profit (+" + str.tostring(rr) + "R): " + f_fmt(tp) + "  (target ≈ $" + str.tostring(rr * lossUSD) + ")\n" +
          "Qty: " + f_qtyFmt(qty) + "\n\n" +
          "Inputs: Spend $" + str.tostring(spendUSD) + " | Risk (1R) $" + str.tostring(lossUSD) + "\n" +
          "Trigger: close back inside after close below lower."

        alert(msg, alert.freq_once_per_bar_close)
        lastAlertBar := bar_index

    armedLong := false
    sweepLow := na
    armedShort := false
    sweepHigh := na

// indicators to help show script functionality on each candle
plotshape(brokeBelowClose, title="Armed Long", style=shape.triangleup, location=location.belowbar, size=size.tiny)
plotshape(longSignal, title="Long Signal", style=shape.circle, location=location.belowbar, size=size.tiny)

plotshape(brokeAboveClose, title="Armed Short", style=shape.triangledown, location=location.abovebar, size=size.tiny)
plotshape(shortSignal, title="Short Signal", style=shape.circle, location=location.abovebar, size=size.tiny)
